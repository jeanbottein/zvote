var Yr=Object.defineProperty;var Qt=e=>{throw TypeError(e)};var Qr=(e,t,r)=>t in e?Yr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var f=(e,t,r)=>Qr(e,typeof t!="symbol"?t+"":t,r),ut=(e,t,r)=>t.has(e)||Qt("Cannot "+r);var a=(e,t,r)=>(ut(e,t,"read from private field"),r?r.call(e):t.get(e)),w=(e,t,r)=>t.has(e)?Qt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),d=(e,t,r,n)=>(ut(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),h=(e,t,r)=>(ut(e,t,"access private method"),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();const xr="utf-8";function x(e,t=void 0){if(e)throw TypeError("Decoder error");return t||65533}function W(e){throw TypeError("The code point "+e+" could not be encoded.")}function gt(e){const t=String(e).trim().toLowerCase();return t in yt?yt[t]:null}const Sr=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"UTF-8"}],heading:"The Encoding"},{encodings:[{labels:["866","cp866","csibm866","ibm866"],name:"IBM866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso88592","iso_8859-2","iso_8859-2:1987","l2","latin2"],name:"ISO-8859-2"},{labels:["csisolatin3","iso-8859-3","iso-ir-109","iso8859-3","iso88593","iso_8859-3","iso_8859-3:1988","l3","latin3"],name:"ISO-8859-3"},{labels:["csisolatin4","iso-8859-4","iso-ir-110","iso8859-4","iso88594","iso_8859-4","iso_8859-4:1988","l4","latin4"],name:"ISO-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso-ir-144","iso8859-5","iso88595","iso_8859-5","iso_8859-5:1988"],name:"ISO-8859-5"},{labels:["arabic","asmo-708","csiso88596e","csiso88596i","csisolatinarabic","ecma-114","iso-8859-6","iso-8859-6-e","iso-8859-6-i","iso-ir-127","iso8859-6","iso88596","iso_8859-6","iso_8859-6:1987"],name:"ISO-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso-ir-126","iso8859-7","iso88597","iso_8859-7","iso_8859-7:1987","sun_eu_greek"],name:"ISO-8859-7"},{labels:["csiso88598e","csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-e","iso-ir-138","iso8859-8","iso88598","iso_8859-8","iso_8859-8:1988","visual"],name:"ISO-8859-8"},{labels:["csiso88598i","iso-8859-8-i","logical"],name:"ISO-8859-8-I"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","iso885910","l6","latin6"],name:"ISO-8859-10"},{labels:["iso-8859-13","iso8859-13","iso885913"],name:"ISO-8859-13"},{labels:["iso-8859-14","iso8859-14","iso885914"],name:"ISO-8859-14"},{labels:["csisolatin9","iso-8859-15","iso8859-15","iso885915","iso_8859-15","l9"],name:"ISO-8859-15"},{labels:["iso-8859-16"],name:"ISO-8859-16"},{labels:["cskoi8r","koi","koi8","koi8-r","koi8_r"],name:"KOI8-R"},{labels:["koi8-ru","koi8-u"],name:"KOI8-U"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["dos-874","iso-8859-11","iso8859-11","iso885911","tis-620","windows-874"],name:"windows-874"},{labels:["cp1250","windows-1250","x-cp1250"],name:"windows-1250"},{labels:["cp1251","windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ansi_x3.4-1968","cp1252","cp819","ibm819","iso-ir-100","windows-1252","x-cp1252"],name:"windows-1252"},{labels:["ascii","us-ascii","iso-8859-1","iso8859-1","iso88591","iso_8859-1","iso_8859-1:1987","l1","latin1","csisolatin1"],name:"iso-8859-1"},{labels:["cp1253","windows-1253","x-cp1253"],name:"windows-1253"},{labels:["cp1254","csisolatin5","iso-8859-9","iso-ir-148","iso8859-9","iso88599","iso_8859-9","iso_8859-9:1989","l5","latin5","windows-1254","x-cp1254"],name:"windows-1254"},{labels:["cp1255","windows-1255","x-cp1255"],name:"windows-1255"},{labels:["cp1256","windows-1256","x-cp1256"],name:"windows-1256"},{labels:["cp1257","windows-1257","x-cp1257"],name:"windows-1257"},{labels:["cp1258","windows-1258","x-cp1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gb_2312","gb_2312-80","gbk","iso-ir-58","x-gbk"],name:"GBK"},{labels:["gb18030"],name:"gb18030"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"Big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"EUC-JP"},{labels:["csiso2022jp","iso-2022-jp"],name:"ISO-2022-JP"},{labels:["csshiftjis","ms932","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"Shift_JIS"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"EUC-KR"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["csiso2022kr","hz-gb-2312","iso-2022-cn","iso-2022-cn-ext","iso-2022-kr"],name:"replacement"},{labels:["utf-16be"],name:"UTF-16BE"},{labels:["utf-16","utf-16le"],name:"UTF-16LE"},{labels:["x-user-defined"],name:"x-user-defined"}],heading:"Legacy miscellaneous encodings"}],yt={};Sr.forEach(e=>{e.encodings.forEach(t=>{t.labels.forEach(r=>{yt[r]=t})})});const z=-1;function Ir(e){return Array.isArray(e)?e:[e]}function m(e,t,r){return t<=e&&e<=r}function ei(e,t){return e.indexOf(t)!==-1}function Ge(e){if(e==null)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function ti(e){const t=String(e),r=t.length;let n=0;const i=[];for(;n<r;){const s=t.charCodeAt(n);if(s<55296||s>57343)i.push(s);else if(56320<=s&&s<=57343)i.push(65533);else if(55296<=s&&s<=56319)if(n===r-1)i.push(65533);else{const c=t.charCodeAt(n+1);if(56320<=c&&c<=57343){const u=s&1023,g=c&1023;i.push(65536+(u<<10)+g),n+=1}else i.push(65533)}n+=1}return i}function ri(e){let t="";for(let r=0;r<e.length;++r){let n=e[r];n<=65535?t+=String.fromCharCode(n):(n-=65536,t+=String.fromCharCode((n>>10)+55296,(n&1023)+56320))}return t}function Ar(){if(typeof global<"u")return global;if(typeof window<"u")return window;if(typeof self<"u")return self}let pt;function ii(){if(typeof TextEncodingIndexes<"u")return TextEncodingIndexes.encodingIndexes;const e=Ar();return e?"TextEncodingIndexes"in e?global.TextEncodingIndexes.encodingIndexes:"encoding-indexes"in e?global.encodingIndexes:null:null}function vr(){if(pt)return pt;const e=ii();return e?(pt=e,e):null}function Fe(e,t){return t&&t[e]||null}function Ue(e,t){const r=t.indexOf(e);return r===-1?null:r}function q(e){const t=vr();if(!t)throw Error("Indexes missing. Did you forget to include encoding-indexes.js first?");return t[e]}function ni(e){if(e>39419&&e<189e3||e>1237575)return null;if(e===7457)return 59335;let t=0,r=0;const n=q("gb18030-ranges");for(let i=0;i<n.length;++i){const s=Ir(n[i]);if(s[0]<=e)t=s[0],r=s[1];else break}return r+e-t}function si(e){if(e===59335)return 7457;let t=0,r=0;const n=q("gb18030-ranges");for(let i=0;i<n.length;++i){const s=n[i],c=Ir(s);if(c[1]<=e)t=c[1],r=c[0];else break}return r+e-t}function ai(e){return dt=dt||q("jis0208").map(function(r,n){return m(n,8272,8835)?null:r}),dt.indexOf(e)}let dt;function oi(e){ht=ht||q("big5").map((r,n)=>n<32*157?null:r);const t=ht;return e===9552||e===9566||e===9569||e===9578||e===21313||e===21317?t.lastIndexOf(e):Ue(e,t)}let ht;function K(e){return 0<=e&&e<=127}const H=K,S=-1;class ci{constructor(t){this.fatal=t.fatal,this.Big5_lead=0}handler(t,r){if(r===S&&this.Big5_lead!==0)return this.Big5_lead=0,x(this.fatal);if(r===S&&this.Big5_lead===0)return z;if(this.Big5_lead!==0){const n=this.Big5_lead;let i=null;this.Big5_lead=0;const s=r<127?64:98;switch((m(r,64,126)||m(r,161,254))&&(i=(n-129)*157+(r-s)),i){case 1133:return[202,772];case 1135:return[202,780];case 1164:return[234,772];case 1166:return[234,780]}const c=i===null?null:Fe(i,q("big5"));return c===null&&K(r)&&t.prepend(r),c===null?x(this.fatal):c}return K(r)?r:m(r,129,254)?(this.Big5_lead=r,null):x(this.fatal)}}class li{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return z;if(H(r))return r;const n=oi(r);if(n===null)return W(r);const i=Math.floor(n/157)+129;if(i<161)return W(r);const s=n%157,c=s<63?64:98;return[i,s+c]}}class ui{constructor(t){this.fatal=t.fatal,this.eucjp_jis0212_flag=!1,this.eucjp_lead=0}handler(t,r){if(r===S&&this.eucjp_lead!==0)return this.eucjp_lead=0,x(this.fatal);if(r===S&&this.eucjp_lead===0)return z;if(this.eucjp_lead===142&&m(r,161,223))return this.eucjp_lead=0,65216+r;if(this.eucjp_lead===143&&m(r,161,254))return this.eucjp_jis0212_flag=!0,this.eucjp_lead=r,null;if(this.eucjp_lead!==0){const n=this.eucjp_lead;this.eucjp_lead=0;let i=null;return m(n,161,254)&&m(r,161,254)&&(i=Fe((n-161)*94+(r-161),q(this.eucjp_jis0212_flag?"jis0212":"jis0208"))),this.eucjp_jis0212_flag=!1,m(r,161,254)||t.prepend(r),i===null?x(this.fatal):i}return K(r)?r:r===142||r===143||m(r,161,254)?(this.eucjp_lead=r,null):x(this.fatal)}}class pi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return z;if(H(r))return r;if(r===165)return 92;if(r===8254)return 126;if(m(r,65377,65439))return[142,r-65377+161];r===8722&&(r=65293);const n=Ue(r,q("jis0208"));if(n===null)return W(r);const i=Math.floor(n/94)+161,s=n%94+161;return[i,s]}}class di{constructor(t){this.fatal=t.fatal,this.euckr_lead=0}handler(t,r){if(r===S&&this.euckr_lead!==0)return this.euckr_lead=0,x(this.fatal);if(r===S&&this.euckr_lead===0)return z;if(this.euckr_lead!==0){const n=this.euckr_lead;let i=null;this.euckr_lead=0,m(r,65,254)&&(i=(n-129)*190+(r-65));const s=i===null?null:Fe(i,q("euc-kr"));return i===null&&K(r)&&t.prepend(r),s===null?x(this.fatal):s}return K(r)?r:m(r,129,254)?(this.euckr_lead=r,null):x(this.fatal)}}class hi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return z;if(H(r))return r;const n=Ue(r,q("euc-kr"));if(n===null)return W(r);const i=Math.floor(n/190)+129,s=n%190+65;return[i,s]}}class er{constructor(t){this.fatal=t.fatal,this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0}handler(t,r){if(r===S&&this.gb18030_first===0&&this.gb18030_second===0&&this.gb18030_third===0)return z;r===S&&(this.gb18030_first!==0||this.gb18030_second!==0||this.gb18030_third!==0)&&(this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0,x(this.fatal));let n;if(this.gb18030_third!==0){n=null,m(r,48,57)&&(n=ni((((this.gb18030_first-129)*10+this.gb18030_second-48)*126+this.gb18030_third-129)*10+r-48));const i=[this.gb18030_second,this.gb18030_third,r];return this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0,n===null?(t.prepend(i),x(this.fatal)):n}if(this.gb18030_second!==0)return m(r,129,254)?(this.gb18030_third=r,null):(t.prepend([this.gb18030_second,r]),this.gb18030_first=0,this.gb18030_second=0,x(this.fatal));if(this.gb18030_first!==0){if(m(r,48,57))return this.gb18030_second=r,null;const i=this.gb18030_first;let s=null;this.gb18030_first=0;const c=r<127?64:65;return(m(r,64,126)||m(r,128,254))&&(s=(i-129)*190+(r-c)),n=s===null?null:Fe(s,q("gb18030")),n===null&&K(r)&&t.prepend(r),n===null?x(this.fatal):n}return K(r)?r:r===128?8364:m(r,129,254)?(this.gb18030_first=r,null):x(this.fatal)}}class tr{constructor(t,r=void 0){this.gbk_flag=r,this.fatal=t.fatal}handler(t,r){if(r===S)return z;if(H(r))return r;if(r===58853)return W(r);if(this.gbk_flag&&r===8364)return 128;let n=Ue(r,q("gb18030"));if(n!==null){const g=Math.floor(n/190)+129,y=n%190,_=y<63?64:65;return[g,y+_]}if(this.gbk_flag)return W(r);n=si(r);const i=Math.floor(n/10/126/10);n=n-i*10*126*10;const s=Math.floor(n/10/126);n=n-s*10*126;const c=Math.floor(n/10),u=n-c*10;return[i+129,s+48,c+129,u+48]}}var E;(function(e){e[e.ASCII=0]="ASCII",e[e.Roman=1]="Roman",e[e.Katakana=2]="Katakana",e[e.LeadByte=3]="LeadByte",e[e.TrailByte=4]="TrailByte",e[e.EscapeStart=5]="EscapeStart",e[e.Escape=6]="Escape"})(E||(E={}));class fi{constructor(t){this.fatal=t.fatal,this.iso2022jp_decoder_state=E.ASCII,this.iso2022jp_decoder_output_state=E.ASCII,this.iso2022jp_lead=0,this.iso2022jp_output_flag=!1}handler(t,r){switch(this.iso2022jp_decoder_state){default:case E.ASCII:return r===27?(this.iso2022jp_decoder_state=E.EscapeStart,null):m(r,0,127)&&r!==14&&r!==15&&r!==27?(this.iso2022jp_output_flag=!1,r):r===S?z:(this.iso2022jp_output_flag=!1,x(this.fatal));case E.Roman:return r===27?(this.iso2022jp_decoder_state=E.EscapeStart,null):r===92?(this.iso2022jp_output_flag=!1,165):r===126?(this.iso2022jp_output_flag=!1,8254):m(r,0,127)&&r!==14&&r!==15&&r!==27&&r!==92&&r!==126?(this.iso2022jp_output_flag=!1,r):r===S?z:(this.iso2022jp_output_flag=!1,x(this.fatal));case E.Katakana:return r===27?(this.iso2022jp_decoder_state=E.EscapeStart,null):m(r,33,95)?(this.iso2022jp_output_flag=!1,65344+r):r===S?z:(this.iso2022jp_output_flag=!1,x(this.fatal));case E.LeadByte:return r===27?(this.iso2022jp_decoder_state=E.EscapeStart,null):m(r,33,126)?(this.iso2022jp_output_flag=!1,this.iso2022jp_lead=r,this.iso2022jp_decoder_state=E.TrailByte,null):r===S?z:(this.iso2022jp_output_flag=!1,x(this.fatal));case E.TrailByte:if(r===27)return this.iso2022jp_decoder_state=E.EscapeStart,x(this.fatal);if(m(r,33,126)){this.iso2022jp_decoder_state=E.LeadByte;const s=(this.iso2022jp_lead-33)*94+r-33,c=Fe(s,q("jis0208"));return c===null?x(this.fatal):c}return r===S?(this.iso2022jp_decoder_state=E.LeadByte,t.prepend(r),x(this.fatal)):(this.iso2022jp_decoder_state=E.LeadByte,x(this.fatal));case E.EscapeStart:return r===36||r===40?(this.iso2022jp_lead=r,this.iso2022jp_decoder_state=E.Escape,null):(t.prepend(r),this.iso2022jp_output_flag=!1,this.iso2022jp_decoder_state=this.iso2022jp_decoder_output_state,x(this.fatal));case E.Escape:const n=this.iso2022jp_lead;this.iso2022jp_lead=0;let i=null;if(n===40&&r===66&&(i=E.ASCII),n===40&&r===74&&(i=E.Roman),n===40&&r===73&&(i=E.Katakana),n===36&&(r===64||r===66)&&(i=E.LeadByte),i!==null){this.iso2022jp_decoder_state=this.iso2022jp_decoder_state=i;const s=this.iso2022jp_output_flag;return this.iso2022jp_output_flag=!0,s?x(this.fatal):null}return t.prepend([n,r]),this.iso2022jp_output_flag=!1,this.iso2022jp_decoder_state=this.iso2022jp_decoder_output_state,x(this.fatal)}}}var L;(function(e){e[e.ASCII=0]="ASCII",e[e.Roman=1]="Roman",e[e.jis0208=2]="jis0208"})(L||(L={}));class gi{constructor(t){this.fatal=t.fatal,this.iso2022jp_state=L.ASCII}handler(t,r){if(r===S&&this.iso2022jp_state!==L.ASCII)return t.prepend(r),this.iso2022jp_state=L.ASCII,[27,40,66];if(r===S&&this.iso2022jp_state===L.ASCII)return z;if((this.iso2022jp_state===L.ASCII||this.iso2022jp_state===L.Roman)&&(r===14||r===15||r===27))return W(65533);if(this.iso2022jp_state===L.ASCII&&H(r))return r;if(this.iso2022jp_state===L.Roman&&(H(r)&&r!==92&&r!==126||r==165||r==8254)){if(H(r))return r;if(r===165)return 92;if(r===8254)return 126}if(H(r)&&this.iso2022jp_state!==L.ASCII)return t.prepend(r),this.iso2022jp_state=L.ASCII,[27,40,66];if((r===165||r===8254)&&this.iso2022jp_state!==L.Roman)return t.prepend(r),this.iso2022jp_state=L.Roman,[27,40,74];r===8722&&(r=65293);const n=Ue(r,q("jis0208"));if(n===null)return W(r);if(this.iso2022jp_state!==L.jis0208)return t.prepend(r),this.iso2022jp_state=L.jis0208,[27,36,66];const i=Math.floor(n/94)+33,s=n%94+33;return[i,s]}}class yi{constructor(t){this.fatal=t.fatal,this.Shift_JIS_lead=0}handler(t,r){if(r===S&&this.Shift_JIS_lead!==0)return this.Shift_JIS_lead=0,x(this.fatal);if(r===S&&this.Shift_JIS_lead===0)return z;if(this.Shift_JIS_lead!==0){const n=this.Shift_JIS_lead;let i=null;this.Shift_JIS_lead=0;const s=r<127?64:65,c=n<160?129:193;if((m(r,64,126)||m(r,128,252))&&(i=(n-c)*188+r-s),m(i,8836,10715))return 48508+i;const u=i===null?null:Fe(i,q("jis0208"));return u===null&&K(r)&&t.prepend(r),u===null?x(this.fatal):u}return K(r)||r===128?r:m(r,161,223)?65216+r:m(r,129,159)||m(r,224,252)?(this.Shift_JIS_lead=r,null):x(this.fatal)}}class Ti{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return z;if(H(r)||r===128)return r;if(r===165)return 92;if(r===8254)return 126;if(m(r,65377,65439))return r-65377+161;r===8722&&(r=65293);const n=ai(r);if(n===null)return W(r);const i=Math.floor(n/188),s=i<31?129:193,c=n%188,u=c<63?64:65;return[i+s,c+u]}}class bi{constructor(t,r){this.index=t,this.fatal=r.fatal}handler(t,r){if(r===S)return z;if(K(r))return r;const n=this.index[r-128];return n||x(this.fatal)}}class mi{constructor(t,r){this.index=t,this.fatal=r.fatal}handler(t,r){if(r===S)return z;if(H(r))return r;const n=Ue(r,this.index);return n===null&&W(r),n+128}}function qe(e,t){const r=e>>8,n=e&255;return t?[r,n]:[n,r]}class rr{constructor(t,r){this.utf16_be=t,this.fatal=r.fatal,this.utf16_lead_byte=null,this.utf16_lead_surrogate=null}handler(t,r){if(r===S&&(this.utf16_lead_byte!==null||this.utf16_lead_surrogate!==null))return x(this.fatal);if(r===S&&this.utf16_lead_byte===null&&this.utf16_lead_surrogate===null)return z;if(this.utf16_lead_byte===null)return this.utf16_lead_byte=r,null;let n;if(this.utf16_be?n=(this.utf16_lead_byte<<8)+r:n=(r<<8)+this.utf16_lead_byte,this.utf16_lead_byte=null,this.utf16_lead_surrogate!==null){const i=this.utf16_lead_surrogate;return this.utf16_lead_surrogate=null,m(n,56320,57343)?65536+(i-55296)*1024+(n-56320):(t.prepend(qe(n,this.utf16_be)),x(this.fatal))}return m(n,55296,56319)?(this.utf16_lead_surrogate=n,null):m(n,56320,57343)?x(this.fatal):n}}class ir{constructor(t,r){this.utf16_be=t,this.fatal=r.fatal}handler(t,r){if(r===S)return z;if(m(r,0,65535))return qe(r,this.utf16_be);const n=qe((r-65536>>10)+55296,this.utf16_be),i=qe((r-65536&1023)+56320,this.utf16_be);return n.concat(i)}}class _i{constructor(t){this.fatal=t.fatal,this.utf8_code_point=0,this.utf8_bytes_seen=0,this.utf8_bytes_needed=0,this.utf8_lower_boundary=128,this.utf8_upper_boundary=191}handler(t,r){if(r===S&&this.utf8_bytes_needed!==0)return this.utf8_bytes_needed=0,x(this.fatal);if(r===S)return z;if(this.utf8_bytes_needed===0){if(m(r,0,127))return r;if(m(r,194,223))this.utf8_bytes_needed=1,this.utf8_code_point=r&31;else if(m(r,224,239))r===224&&(this.utf8_lower_boundary=160),r===237&&(this.utf8_upper_boundary=159),this.utf8_bytes_needed=2,this.utf8_code_point=r&15;else if(m(r,240,244))r===240&&(this.utf8_lower_boundary=144),r===244&&(this.utf8_upper_boundary=143),this.utf8_bytes_needed=3,this.utf8_code_point=r&7;else return x(this.fatal);return null}if(!m(r,this.utf8_lower_boundary,this.utf8_upper_boundary))return this.utf8_code_point=this.utf8_bytes_needed=this.utf8_bytes_seen=0,this.utf8_lower_boundary=128,this.utf8_upper_boundary=191,t.prepend(r),x(this.fatal);if(this.utf8_lower_boundary=128,this.utf8_upper_boundary=191,this.utf8_code_point=this.utf8_code_point<<6|r&63,this.utf8_bytes_seen+=1,this.utf8_bytes_seen!==this.utf8_bytes_needed)return null;const n=this.utf8_code_point;return this.utf8_code_point=this.utf8_bytes_needed=this.utf8_bytes_seen=0,n}}class wi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return z;if(H(r))return r;let n,i;m(r,128,2047)?(n=1,i=192):m(r,2048,65535)?(n=2,i=224):m(r,65536,1114111)&&(n=3,i=240);const s=[(r>>6*n)+i];for(;n>0;){const c=r>>6*(n-1);s.push(128|c&63),n-=1}return s}}class xi{constructor(t){this.fatal=t.fatal}handler(t,r){return r===S?z:K(r)?r:63360+r-128}}class Si{constructor(t){this.fatal=t.fatal}handler(t,r){return r===S?z:H(r)?r:m(r,63360,63487)?r-63360+128:W(r)}}const Ii=vr(),Tt={"UTF-8":e=>new wi(e),GBK:e=>new tr(e,!0),gb18030:e=>new tr(e),Big5:e=>new li(e),"EUC-JP":e=>new pi(e),"ISO-2022-JP":e=>new gi(e),Shift_JIS:e=>new Ti(e),"EUC-KR":e=>new hi(e),"UTF-16BE":e=>new ir(!0,e),"UTF-16LE":e=>new ir(!1,e),"x-user-defined":e=>new Si(e)},bt={"UTF-8":e=>new _i(e),GBK:e=>new er(e),gb18030:e=>new er(e),Big5:e=>new ci(e),"EUC-JP":e=>new ui(e),"ISO-2022-JP":e=>new fi(e),Shift_JIS:e=>new yi(e),"EUC-KR":e=>new di(e),"UTF-16BE":e=>new rr(!0,e),"UTF-16LE":e=>new rr(!1,e),"x-user-defined":e=>new xi(e)};Ii&&Sr.forEach(function(e){e.heading==="Legacy single-byte encodings"&&e.encodings.forEach(function(t){const r=t.name,n=q(r.toLowerCase());bt[r]=function(i){return new bi(n,i)},Tt[r]=function(i){return new mi(n,i)}})});class Fr{constructor(t){this.tokens=Array.from(t),this.tokens.reverse()}endOfStream(){return!this.tokens.length}read(){return this.tokens.length?this.tokens.pop():S}prepend(t){if(Array.isArray(t)){const r=t;for(;r.length;)this.tokens.push(r.pop())}else this.tokens.push(t)}push(t){if(Array.isArray(t)){const r=t;for(;r.length;)this.tokens.unshift(r.shift())}else this.tokens.unshift(t)}}class Ur{constructor(t,r){t=t!==void 0?String(t):xr;const n=Ge(r);this._encoding=null,this._decoder=null,this._ignoreBOM=!1,this._BOMseen=!1,this._error_mode="replacement",this._do_not_flush=!1;const i=gt(t);if(i===null||i.name==="replacement")throw RangeError("Unknown encoding: "+t);if(!bt[i.name])throw Error("Decoder not present. Did you forget to include encoding-indexes.js first?");this._encoding=i,n.fatal&&(this._error_mode="fatal"),n.ignoreBOM&&(this._ignoreBOM=!0)}get encoding(){return this._encoding.name.toLowerCase()}get fatal(){return this._error_mode==="fatal"}get ignoreBOM(){return this._ignoreBOM}decode(t,r){const n=Ai(t),i=Ge(r);this._do_not_flush||(this._decoder=bt[this._encoding.name]({fatal:this._error_mode==="fatal"}),this._BOMseen=!1),this._do_not_flush=!!i.stream;const s=new Fr(n),c=[];let u;for(;;){const g=s.read();if(g===S||(u=this._decoder.handler(s,g),u===z))break;u!==null&&(Array.isArray(u)?c.push.apply(c,u):c.push(u))}if(!this._do_not_flush){do{if(u=this._decoder.handler(s,s.read()),u===z)break;u&&(Array.isArray(u)?c.push.apply(c,u):c.push(u))}while(!s.endOfStream());this._decoder=null}return this.serializeStream(c)}serializeStream(t){return ei(["UTF-8","UTF-16LE","UTF-16BE"],this._encoding.name)&&!this._ignoreBOM&&!this._BOMseen&&(t.length>0&&t[0]===65279?(this._BOMseen=!0,t.shift()):t.length>0&&(this._BOMseen=!0)),ri(t)}}function nr(e){try{return e instanceof ArrayBuffer}catch(t){return console.error(t),!1}}function Ai(e){return typeof e!="object"?new Uint8Array(0):nr(e)?new Uint8Array(e):"buffer"in e&&nr(e.buffer)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0)}class zr{constructor(t,r){const n=Ge(r);if(this._encoding=null,this._encoder=null,this._do_not_flush=!1,this._fatal=n.fatal?"fatal":"replacement",n.NONSTANDARD_allowLegacyEncoding){t=t?String(t):xr;const i=gt(t);if(i===null||i.name==="replacement")throw RangeError("Unknown encoding: "+t);if(!Tt[i.name])throw Error("Encoder not present. Did you forget to include encoding-indexes.js first?");this._encoding=i}else{this._encoding=gt("utf-8");const i=Ar()||{};t!==void 0&&"console"in i&&console.warn("TextEncoder constructor called with encoding label, which is ignored.")}}get encoding(){return this._encoding.name.toLowerCase()}encode(t,r){t=t===void 0?"":String(t);const n=Ge(r);this._do_not_flush||(this._encoder=Tt[this._encoding.name]({fatal:this._fatal==="fatal"})),this._do_not_flush=!!n.stream;const i=new Fr(ti(t)),s=[];let c;for(;;){const u=i.read();if(u===S||(c=this._encoder.handler(i,u),c===z))break;Array.isArray(c)?s.push.apply(s,c):s.push(c)}if(!this._do_not_flush){for(;c=this._encoder.handler(i,i.read()),c!==z;)Array.isArray(c)?s.push.apply(s,c):s.push(c);this._encoder=null}return new Uint8Array(s)}}if(typeof window<"u"){const e=t=>!(t in window)||typeof window[t]>"u"||window[t]===null;e("TextDecoder")&&(window.TextDecoder=Ur),e("TextEncoder")&&(window.TextEncoder=zr)}var Er=zi,X=[],sr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Le=0,vi=sr.length;Le<vi;++Le)X[Le]=sr[Le];function Fi(e){return X[e>>18&63]+X[e>>12&63]+X[e>>6&63]+X[e&63]}function Ui(e,t,r){for(var n,i=[],s=t;s<r;s+=3)n=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(e[s+2]&255),i.push(Fi(n));return i.join("")}function zi(e){for(var t,r=e.length,n=r%3,i=[],s=16383,c=0,u=r-n;c<u;c+=s)i.push(Ui(e,c,c+s>u?u:c+s));return n===1?(t=e[r-1],i.push(X[t>>2]+X[t<<4&63]+"==")):n===2&&(t=(e[r-2]<<8)+e[r-1],i.push(X[t>>10]+X[t>>4&63]+X[t<<2&63]+"=")),i.join("")}var I,T,hr,me=(hr=class{constructor(e){w(this,I);w(this,T,0);d(this,I,new DataView(e.buffer)),d(this,T,e.byteOffset)}get offset(){return a(this,T)}readUInt8Array(){const e=this.readU32(),t=new Uint8Array(a(this,I).buffer,a(this,T),e);return d(this,T,a(this,T)+e),t}readBool(){const e=a(this,I).getUint8(a(this,T));return d(this,T,a(this,T)+1),e!==0}readByte(){const e=a(this,I).getUint8(a(this,T));return d(this,T,a(this,T)+1),e}readBytes(e){const t=new DataView(a(this,I).buffer,a(this,T),e);return d(this,T,a(this,T)+e),new Uint8Array(t.buffer)}readI8(){const e=a(this,I).getInt8(a(this,T));return d(this,T,a(this,T)+1),e}readU8(){const e=a(this,I).getUint8(a(this,T));return d(this,T,a(this,T)+1),e}readI16(){const e=a(this,I).getInt16(a(this,T),!0);return d(this,T,a(this,T)+2),e}readU16(){const e=a(this,I).getUint16(a(this,T),!0);return d(this,T,a(this,T)+2),e}readI32(){const e=a(this,I).getInt32(a(this,T),!0);return d(this,T,a(this,T)+4),e}readU32(){const e=a(this,I).getUint32(a(this,T),!0);return d(this,T,a(this,T)+4),e}readI64(){const e=a(this,I).getBigInt64(a(this,T),!0);return d(this,T,a(this,T)+8),e}readU64(){const e=a(this,I).getBigUint64(a(this,T),!0);return d(this,T,a(this,T)+8),e}readU128(){const e=a(this,I).getBigUint64(a(this,T),!0),t=a(this,I).getBigUint64(a(this,T)+8,!0);return d(this,T,a(this,T)+16),(t<<BigInt(64))+e}readI128(){const e=a(this,I).getBigUint64(a(this,T),!0),t=a(this,I).getBigInt64(a(this,T)+8,!0);return d(this,T,a(this,T)+16),(t<<BigInt(64))+e}readU256(){const e=a(this,I).getBigUint64(a(this,T),!0),t=a(this,I).getBigUint64(a(this,T)+8,!0),r=a(this,I).getBigUint64(a(this,T)+16,!0),n=a(this,I).getBigUint64(a(this,T)+24,!0);return d(this,T,a(this,T)+32),(n<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readI256(){const e=a(this,I).getBigUint64(a(this,T),!0),t=a(this,I).getBigUint64(a(this,T)+8,!0),r=a(this,I).getBigUint64(a(this,T)+16,!0),n=a(this,I).getBigInt64(a(this,T)+24,!0);return d(this,T,a(this,T)+32),(n<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readF32(){const e=a(this,I).getFloat32(a(this,T),!0);return d(this,T,a(this,T)+4),e}readF64(){const e=a(this,I).getFloat64(a(this,T),!0);return d(this,T,a(this,T)+8),e}readString(){const e=this.readU32(),t=new Uint8Array(a(this,I).buffer,a(this,T),e),n=new Ur("utf-8").decode(t);return d(this,T,a(this,T)+e),n}},I=new WeakMap,T=new WeakMap,hr),$,v,b,O,D,fr,Y=(fr=class{constructor(e){w(this,O);w(this,$);w(this,v);w(this,b,0);d(this,$,new Uint8Array(e)),d(this,v,new DataView(a(this,$).buffer))}toBase64(){return Er(a(this,$).subarray(0,a(this,b)))}getBuffer(){return a(this,$).slice(0,a(this,b))}writeUInt8Array(e){const t=e.length;h(this,O,D).call(this,4+t),this.writeU32(t),a(this,$).set(e,a(this,b)),d(this,b,a(this,b)+e.length)}writeBool(e){h(this,O,D).call(this,1),a(this,v).setUint8(a(this,b),e?1:0),d(this,b,a(this,b)+1)}writeByte(e){h(this,O,D).call(this,1),a(this,v).setUint8(a(this,b),e),d(this,b,a(this,b)+1)}writeI8(e){h(this,O,D).call(this,1),a(this,v).setInt8(a(this,b),e),d(this,b,a(this,b)+1)}writeU8(e){h(this,O,D).call(this,1),a(this,v).setUint8(a(this,b),e),d(this,b,a(this,b)+1)}writeI16(e){h(this,O,D).call(this,2),a(this,v).setInt16(a(this,b),e,!0),d(this,b,a(this,b)+2)}writeU16(e){h(this,O,D).call(this,2),a(this,v).setUint16(a(this,b),e,!0),d(this,b,a(this,b)+2)}writeI32(e){h(this,O,D).call(this,4),a(this,v).setInt32(a(this,b),e,!0),d(this,b,a(this,b)+4)}writeU32(e){h(this,O,D).call(this,4),a(this,v).setUint32(a(this,b),e,!0),d(this,b,a(this,b)+4)}writeI64(e){h(this,O,D).call(this,8),a(this,v).setBigInt64(a(this,b),e,!0),d(this,b,a(this,b)+8)}writeU64(e){h(this,O,D).call(this,8),a(this,v).setBigUint64(a(this,b),e,!0),d(this,b,a(this,b)+8)}writeU128(e){h(this,O,D).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);a(this,v).setBigUint64(a(this,b),t,!0),a(this,v).setBigUint64(a(this,b)+8,r,!0),d(this,b,a(this,b)+16)}writeI128(e){h(this,O,D).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);a(this,v).setBigInt64(a(this,b),t,!0),a(this,v).setBigInt64(a(this,b)+8,r,!0),d(this,b,a(this,b)+16)}writeU256(e){h(this,O,D).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,n=e>>BigInt(64*1)&t,i=e>>BigInt(64*2)&t,s=e>>BigInt(64*3);a(this,v).setBigUint64(a(this,b)+8*0,r,!0),a(this,v).setBigUint64(a(this,b)+8*1,n,!0),a(this,v).setBigUint64(a(this,b)+8*2,i,!0),a(this,v).setBigUint64(a(this,b)+8*3,s,!0),d(this,b,a(this,b)+32)}writeI256(e){h(this,O,D).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,n=e>>BigInt(64*1)&t,i=e>>BigInt(64*2)&t,s=e>>BigInt(64*3);a(this,v).setBigUint64(a(this,b)+8*0,r,!0),a(this,v).setBigUint64(a(this,b)+8*1,n,!0),a(this,v).setBigUint64(a(this,b)+8*2,i,!0),a(this,v).setBigInt64(a(this,b)+8*3,s,!0),d(this,b,a(this,b)+32)}writeF32(e){h(this,O,D).call(this,4),a(this,v).setFloat32(a(this,b),e,!0),d(this,b,a(this,b)+4)}writeF64(e){h(this,O,D).call(this,8),a(this,v).setFloat64(a(this,b),e,!0),d(this,b,a(this,b)+8)}writeString(e){const r=new zr().encode(e);this.writeU32(r.length),h(this,O,D).call(this,r.length),a(this,$).set(r,a(this,b)),d(this,b,a(this,b)+r.length)}},$=new WeakMap,v=new WeakMap,b=new WeakMap,O=new WeakSet,D=function(e){const t=a(this,b)+e+1;if(t<=a(this,$).length)return;let r=a(this,$).length*2;r<t&&(r=t);const n=new Uint8Array(r);n.set(a(this,$)),d(this,$,n),d(this,v,new DataView(a(this,$).buffer))},fr);function Re(e,t){if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let i of r)if(!n.includes(i)||!Re(e[i],t[i]))return!1;return!0}function Cr(e){return Array.prototype.map.call(e.reverse(),t=>("00"+t.toString(16)).slice(-2)).join("")}function Ei(e){if(e.length!=16)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new me(e).readU128()}function Ci(e){if(e.length!=32)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new me(e).readU256()}function Br(e){e.startsWith("0x")&&(e=e.slice(2));let t=e.match(/.{1,2}/g)||[],r=Uint8Array.from(t.map(n=>parseInt(n,16)));return r.length!=32?new Uint8Array(0):r.reverse()}function Bi(e){return Ei(Br(e))}function ki(e){return Ci(Br(e))}function kr(e){let t=new Y(16);return t.writeU128(e),t.getBuffer()}function Oi(e){return Cr(kr(e))}function Or(e){let t=new Y(32);return t.writeU256(e),t.getBuffer()}function Di(e){return Cr(Or(e))}var mt=class $e{constructor(t){f(this,"data");this.data=t}get __connection_id__(){return this.data}isZero(){return this.data===BigInt(0)}static nullIfZero(t){return t.isZero()?null:t}static random(){function t(){return Math.floor(Math.random()*255)}let r=BigInt(0);for(let n=0;n<16;n++)r=r<<BigInt(8)|BigInt(t());return new $e(r)}isEqual(t){return this.data==t.data}toHexString(){return Oi(this.data)}toUint8Array(){return kr(this.data)}static fromString(t){return new $e(Bi(t))}static fromStringOrNull(t){let r=$e.fromString(t);return r.isZero()?null:r}},te,Pi=(te=class{constructor(t){f(this,"__time_duration_micros__");this.__time_duration_micros__=t}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/te.MICROS_PER_MILLIS)}static fromMillis(t){return new te(BigInt(t)*te.MICROS_PER_MILLIS)}},f(te,"MICROS_PER_MILLIS",1000n),te),V,ji=(V=class{constructor(t){f(this,"__timestamp_micros_since_unix_epoch__");this.__timestamp_micros_since_unix_epoch__=t}get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}static now(){return V.fromDate(new Date)}static fromDate(t){const r=t.getTime(),n=BigInt(r)*V.MICROS_PER_MILLIS;return new V(n)}toDate(){const r=this.__timestamp_micros_since_unix_epoch__/V.MICROS_PER_MILLIS;if(r>BigInt(Number.MAX_SAFE_INTEGER)||r<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(r))}},f(V,"MICROS_PER_MILLIS",1000n),f(V,"UNIX_EPOCH",new V(0n)),V),Mi=class Dr{constructor(t){f(this,"data");this.data=typeof t=="string"?ki(t):t}get __identity__(){return this.data}isEqual(t){return this.toHexString()===t.toHexString()}toHexString(){return Di(this.data)}toUint8Array(){return Or(this.data)}static fromString(t){return new Dr(t)}},_t;(e=>{function t(){return o.createSumType([new F("Interval",o.createTimeDurationType()),new F("Time",o.createTimestampType())])}e.getAlgebraicType=t,e.Interval=n=>({tag:"Interval",value:{__time_duration_micros__:n}}),e.Time=n=>({tag:"Time",value:{__timestamp_micros_since_unix_epoch__:n}});function r(n){let i=n.asSumValue();switch(i.tag){case 0:return{tag:"Interval",value:{__time_duration_micros__:i.value.asProductValue().elements[0].asBigInt()}};case 1:return{tag:"Time",value:{__timestamp_micros_since_unix_epoch__:i.value.asBigInt()}};default:throw"unreachable"}}e.fromValue=r})(_t||(_t={}));var Ri=_t,F=class{constructor(e,t){f(this,"name");f(this,"algebraicType");this.name=e,this.algebraicType=t}},Li=class{constructor(e){f(this,"variants");f(this,"serialize",(e,t)=>{if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none")t!=null?(e.writeByte(0),this.variants[0].algebraicType.serialize(e,t)):e.writeByte(1);else{let r=t.tag;const n=this.variants.findIndex(i=>i.name===r);if(n<0)throw`Can't serialize a sum type, couldn't find ${t.tag} tag`;e.writeU8(n),this.variants[n].algebraicType.serialize(e,t.value)}});f(this,"deserialize",e=>{let t=e.readU8();if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none"){if(t===0)return this.variants[0].algebraicType.deserialize(e);if(t===1)return;throw`Can't deserialize an option type, couldn't find ${t} tag`}else{let r=this.variants[t],n=r.algebraicType.deserialize(e);return{tag:r.name,value:n}}});this.variants=e}},l=class{constructor(e,t){f(this,"name");f(this,"algebraicType");this.name=e,this.algebraicType=t}},Ni=class{constructor(e){f(this,"elements");f(this,"serialize",(e,t)=>{for(let r of this.elements)r.algebraicType.serialize(e,t[r.name])});f(this,"deserialize",e=>{let t={};if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return new Pi(e.readI64());if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return new ji(e.readI64());if(this.elements[0].name==="__identity__")return new Mi(e.readU256());if(this.elements[0].name==="__connection_id__")return new mt(e.readU128())}for(let r of this.elements)t[r.name]=r.algebraicType.deserialize(e);return t});this.elements=e}isEmpty(){return this.elements.length===0}intoMapKey(e){if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return e.__time_duration_micros__;if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return e.__timestamp_micros_since_unix_epoch__;if(this.elements[0].name==="__identity__")return e.__identity__;if(this.elements[0].name==="__connection_id__")return e.__connection_id__}const t=new Y(10);return this.serialize(t,e),t.toBase64()}},qi=class{constructor(e,t){f(this,"keyType");f(this,"valueType");this.keyType=e,this.valueType=t}},R,Te,B,le,k,wt,xt,St,o=(le=class{constructor(){w(this,R);f(this,"type");f(this,"type_")}get product(){if(this.type!==p.ProductType)throw"product type was requested, but the type is not ProductType";return this.type_}set product(t){h(this,R,Te).call(this,p.ProductType,t)}get sum(){if(this.type!==p.SumType)throw"sum type was requested, but the type is not SumType";return this.type_}set sum(t){h(this,R,Te).call(this,p.SumType,t)}get array(){if(this.type!==p.ArrayType)throw"array type was requested, but the type is not ArrayType";return this.type_}set array(t){h(this,R,Te).call(this,p.ArrayType,t)}get map(){if(this.type!==p.MapType)throw"map type was requested, but the type is not MapType";return this.type_}set map(t){h(this,R,Te).call(this,p.MapType,t)}static createProductType(t){return h(this,B,k).call(this,p.ProductType,new Ni(t))}static createSumType(t){return h(this,B,k).call(this,p.SumType,new Li(t))}static createArrayType(t){return h(this,B,k).call(this,p.ArrayType,t)}static createMapType(t,r){return h(this,B,k).call(this,p.MapType,new qi(t,r))}static createBoolType(){return h(this,B,k).call(this,p.Bool,null)}static createI8Type(){return h(this,B,k).call(this,p.I8,null)}static createU8Type(){return h(this,B,k).call(this,p.U8,null)}static createI16Type(){return h(this,B,k).call(this,p.I16,null)}static createU16Type(){return h(this,B,k).call(this,p.U16,null)}static createI32Type(){return h(this,B,k).call(this,p.I32,null)}static createU32Type(){return h(this,B,k).call(this,p.U32,null)}static createI64Type(){return h(this,B,k).call(this,p.I64,null)}static createU64Type(){return h(this,B,k).call(this,p.U64,null)}static createI128Type(){return h(this,B,k).call(this,p.I128,null)}static createU128Type(){return h(this,B,k).call(this,p.U128,null)}static createI256Type(){return h(this,B,k).call(this,p.I256,null)}static createU256Type(){return h(this,B,k).call(this,p.U256,null)}static createF32Type(){return h(this,B,k).call(this,p.F32,null)}static createF64Type(){return h(this,B,k).call(this,p.F64,null)}static createStringType(){return h(this,B,k).call(this,p.String,null)}static createBytesType(){return this.createArrayType(this.createU8Type())}static createOptionType(t){return this.createSumType([new F("some",t),new F("none",this.createProductType([]))])}static createIdentityType(){return this.createProductType([new l("__identity__",this.createU256Type())])}static createConnectionIdType(){return this.createProductType([new l("__connection_id__",this.createU128Type())])}static createScheduleAtType(){return Ri.getAlgebraicType()}static createTimestampType(){return this.createProductType([new l("__timestamp_micros_since_unix_epoch__",this.createI64Type())])}static createTimeDurationType(){return this.createProductType([new l("__time_duration_micros__",this.createI64Type())])}isProductType(){return this.type===p.ProductType}isSumType(){return this.type===p.SumType}isArrayType(){return this.type===p.ArrayType}isMapType(){return this.type===p.MapType}isIdentity(){return h(this,R,xt).call(this,"__identity__")}isConnectionId(){return h(this,R,xt).call(this,"__connection_id__")}isScheduleAt(){return this.isSumType()&&this.sum.variants.length===2&&this.sum.variants[0].name==="Interval"&&this.sum.variants[0].algebraicType.type===p.U64&&this.sum.variants[1].name==="Time"&&this.sum.variants[1].algebraicType.type===p.U64}isTimestamp(){return h(this,R,St).call(this,"__timestamp_micros_since_unix_epoch__")}isTimeDuration(){return h(this,R,St).call(this,"__time_duration_micros__")}intoMapKey(t){switch(this.type){case p.U8:case p.U16:case p.U32:case p.U64:case p.U128:case p.U256:case p.I8:case p.I16:case p.I64:case p.I128:case p.F32:case p.F64:case p.String:case p.Bool:return t;case p.ProductType:return this.product.intoMapKey(t);default:const r=new Y(10);return this.serialize(r,t),r.toBase64()}}serialize(t,r){switch(this.type){case p.ProductType:this.product.serialize(t,r);break;case p.SumType:this.sum.serialize(t,r);break;case p.ArrayType:if(h(this,R,wt).call(this))t.writeUInt8Array(r);else{const n=this.array;t.writeU32(r.length);for(let i of r)n.serialize(t,i)}break;case p.MapType:throw new Error("not implemented");case p.Bool:t.writeBool(r);break;case p.I8:t.writeI8(r);break;case p.U8:t.writeU8(r);break;case p.I16:t.writeI16(r);break;case p.U16:t.writeU16(r);break;case p.I32:t.writeI32(r);break;case p.U32:t.writeU32(r);break;case p.I64:t.writeI64(r);break;case p.U64:t.writeU64(r);break;case p.I128:t.writeI128(r);break;case p.U128:t.writeU128(r);break;case p.I256:t.writeI256(r);break;case p.U256:t.writeU256(r);break;case p.F32:t.writeF32(r);break;case p.F64:t.writeF64(r);break;case p.String:t.writeString(r);break;default:throw new Error(`not implemented, ${this.type}`)}}deserialize(t){switch(this.type){case p.ProductType:return this.product.deserialize(t);case p.SumType:return this.sum.deserialize(t);case p.ArrayType:if(h(this,R,wt).call(this))return t.readUInt8Array();{const r=this.array,n=t.readU32();let i=[];for(let s=0;s<n;s++)i.push(r.deserialize(t));return i}case p.MapType:throw new Error("not implemented");case p.Bool:return t.readBool();case p.I8:return t.readI8();case p.U8:return t.readU8();case p.I16:return t.readI16();case p.U16:return t.readU16();case p.I32:return t.readI32();case p.U32:return t.readU32();case p.I64:return t.readI64();case p.U64:return t.readU64();case p.I128:return t.readI128();case p.U128:return t.readU128();case p.U256:return t.readU256();case p.F32:return t.readF32();case p.F64:return t.readF64();case p.String:return t.readString();default:throw new Error(`not implemented, ${this.type}`)}}},R=new WeakSet,Te=function(t,r){this.type_=r,this.type=r===void 0?p.None:t},B=new WeakSet,k=function(t,r){var i;let n=new le;return h(i=n,R,Te).call(i,t,r),n},wt=function(){return this.isArrayType()&&this.array.type==p.U8},xt=function(t){return this.isProductType()&&this.product.elements.length===1&&(this.product.elements[0].algebraicType.type==p.U128||this.product.elements[0].algebraicType.type==p.U256)&&this.product.elements[0].name===t},St=function(t){return this.isProductType()&&this.product.elements.length===1&&this.product.elements[0].algebraicType.type===p.I64&&this.product.elements[0].name===t},w(le,B),le);(e=>{(t=>{t.SumType="SumType",t.ProductType="ProductType",t.ArrayType="ArrayType",t.MapType="MapType",t.Bool="Bool",t.I8="I8",t.U8="U8",t.I16="I16",t.U16="U16",t.I32="I32",t.U32="U32",t.I64="I64",t.U64="U64",t.I128="I128",t.U128="U128",t.I256="I256",t.U256="U256",t.F32="F32",t.F64="F64",t.String="String",t.None="None"})(e.Type||(e.Type={}))})(o||(o={}));var p=o.Type;function $i(e,t){const r=new me(t);return e.deserialize(r)}var It;(e=>{e.FixedSize=i=>({tag:"FixedSize",value:i}),e.RowOffsets=i=>({tag:"RowOffsets",value:i});function t(){return o.createSumType([new F("FixedSize",o.createU16Type()),new F("RowOffsets",o.createArrayType(o.createU64Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(It||(It={}));var Ee;(e=>{function t(){return o.createProductType([new l("sizeHint",It.getTypeScriptAlgebraicType()),new l("rowsData",o.createArrayType(o.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ee||(Ee={}));var At;(e=>{function t(){return o.createProductType([new l("reducer",o.createStringType()),new l("args",o.createArrayType(o.createU8Type())),new l("requestId",o.createU32Type()),new l("flags",o.createU8Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(At||(At={}));var vt;(e=>{function t(){return o.createProductType([new l("queryStrings",o.createArrayType(o.createStringType())),new l("requestId",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(vt||(vt={}));var Ft;(e=>{function t(){return o.createProductType([new l("messageId",o.createArrayType(o.createU8Type())),new l("queryString",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ft||(Ft={}));var Q;(e=>{function t(){return o.createProductType([new l("id",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Q||(Q={}));var Ut;(e=>{function t(){return o.createProductType([new l("query",o.createStringType()),new l("requestId",o.createU32Type()),new l("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ut||(Ut={}));var zt;(e=>{function t(){return o.createProductType([new l("queryStrings",o.createArrayType(o.createStringType())),new l("requestId",o.createU32Type()),new l("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(zt||(zt={}));var Et;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Et||(Et={}));var Ct;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ct||(Ct={}));var be;(e=>{e.CallReducer=i=>({tag:"CallReducer",value:i}),e.Subscribe=i=>({tag:"Subscribe",value:i}),e.OneOffQuery=i=>({tag:"OneOffQuery",value:i}),e.SubscribeSingle=i=>({tag:"SubscribeSingle",value:i}),e.SubscribeMulti=i=>({tag:"SubscribeMulti",value:i}),e.Unsubscribe=i=>({tag:"Unsubscribe",value:i}),e.UnsubscribeMulti=i=>({tag:"UnsubscribeMulti",value:i});function t(){return o.createSumType([new F("CallReducer",At.getTypeScriptAlgebraicType()),new F("Subscribe",vt.getTypeScriptAlgebraicType()),new F("OneOffQuery",Ft.getTypeScriptAlgebraicType()),new F("SubscribeSingle",Ut.getTypeScriptAlgebraicType()),new F("SubscribeMulti",zt.getTypeScriptAlgebraicType()),new F("Unsubscribe",Et.getTypeScriptAlgebraicType()),new F("UnsubscribeMulti",Ct.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(be||(be={}));var We;(e=>{function t(){return o.createProductType([new l("deletes",Ee.getTypeScriptAlgebraicType()),new l("inserts",Ee.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(We||(We={}));var Bt;(e=>{e.Uncompressed=i=>({tag:"Uncompressed",value:i}),e.Brotli=i=>({tag:"Brotli",value:i}),e.Gzip=i=>({tag:"Gzip",value:i});function t(){return o.createSumType([new F("Uncompressed",We.getTypeScriptAlgebraicType()),new F("Brotli",o.createArrayType(o.createU8Type())),new F("Gzip",o.createArrayType(o.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Bt||(Bt={}));var Ze;(e=>{function t(){return o.createProductType([new l("tableId",o.createU32Type()),new l("tableName",o.createStringType()),new l("numRows",o.createU64Type()),new l("updates",o.createArrayType(Bt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ze||(Ze={}));var he;(e=>{function t(){return o.createProductType([new l("tables",o.createArrayType(Ze.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(he||(he={}));var kt;(e=>{function t(){return o.createProductType([new l("databaseUpdate",he.getTypeScriptAlgebraicType()),new l("requestId",o.createU32Type()),new l("totalHostExecutionDuration",o.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(kt||(kt={}));var Ot;(e=>{e.Committed=i=>({tag:"Committed",value:i}),e.Failed=i=>({tag:"Failed",value:i}),e.OutOfEnergy={tag:"OutOfEnergy"};function t(){return o.createSumType([new F("Committed",he.getTypeScriptAlgebraicType()),new F("Failed",o.createStringType()),new F("OutOfEnergy",o.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ot||(Ot={}));var Dt;(e=>{function t(){return o.createProductType([new l("reducerName",o.createStringType()),new l("reducerId",o.createU32Type()),new l("args",o.createArrayType(o.createU8Type())),new l("requestId",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Dt||(Dt={}));var Pt;(e=>{function t(){return o.createProductType([new l("quanta",o.createU128Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Pt||(Pt={}));var jt;(e=>{function t(){return o.createProductType([new l("status",Ot.getTypeScriptAlgebraicType()),new l("timestamp",o.createTimestampType()),new l("callerIdentity",o.createIdentityType()),new l("callerConnectionId",o.createConnectionIdType()),new l("reducerCall",Dt.getTypeScriptAlgebraicType()),new l("energyQuantaUsed",Pt.getTypeScriptAlgebraicType()),new l("totalHostExecutionDuration",o.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(jt||(jt={}));var Mt;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("update",he.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Mt||(Mt={}));var Rt;(e=>{function t(){return o.createProductType([new l("identity",o.createIdentityType()),new l("token",o.createStringType()),new l("connectionId",o.createConnectionIdType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Rt||(Rt={}));var Lt;(e=>{function t(){return o.createProductType([new l("tableName",o.createStringType()),new l("rows",Ee.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Lt||(Lt={}));var Nt;(e=>{function t(){return o.createProductType([new l("messageId",o.createArrayType(o.createU8Type())),new l("error",o.createOptionType(o.createStringType())),new l("tables",o.createArrayType(Lt.getTypeScriptAlgebraicType())),new l("totalHostExecutionDuration",o.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Nt||(Nt={}));var Xe;(e=>{function t(){return o.createProductType([new l("tableId",o.createU32Type()),new l("tableName",o.createStringType()),new l("tableRows",Ze.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Xe||(Xe={}));var qt;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("totalHostExecutionDurationMicros",o.createU64Type()),new l("queryId",Q.getTypeScriptAlgebraicType()),new l("rows",Xe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(qt||(qt={}));var $t;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("totalHostExecutionDurationMicros",o.createU64Type()),new l("queryId",Q.getTypeScriptAlgebraicType()),new l("rows",Xe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})($t||($t={}));var Vt;(e=>{function t(){return o.createProductType([new l("totalHostExecutionDurationMicros",o.createU64Type()),new l("requestId",o.createOptionType(o.createU32Type())),new l("queryId",o.createOptionType(o.createU32Type())),new l("tableId",o.createOptionType(o.createU32Type())),new l("error",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Vt||(Vt={}));var Ht;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("totalHostExecutionDurationMicros",o.createU64Type()),new l("queryId",Q.getTypeScriptAlgebraicType()),new l("update",he.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ht||(Ht={}));var Kt;(e=>{function t(){return o.createProductType([new l("requestId",o.createU32Type()),new l("totalHostExecutionDurationMicros",o.createU64Type()),new l("queryId",Q.getTypeScriptAlgebraicType()),new l("update",he.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Kt||(Kt={}));var Jt;(e=>{e.InitialSubscription=i=>({tag:"InitialSubscription",value:i}),e.TransactionUpdate=i=>({tag:"TransactionUpdate",value:i}),e.TransactionUpdateLight=i=>({tag:"TransactionUpdateLight",value:i}),e.IdentityToken=i=>({tag:"IdentityToken",value:i}),e.OneOffQueryResponse=i=>({tag:"OneOffQueryResponse",value:i}),e.SubscribeApplied=i=>({tag:"SubscribeApplied",value:i}),e.UnsubscribeApplied=i=>({tag:"UnsubscribeApplied",value:i}),e.SubscriptionError=i=>({tag:"SubscriptionError",value:i}),e.SubscribeMultiApplied=i=>({tag:"SubscribeMultiApplied",value:i}),e.UnsubscribeMultiApplied=i=>({tag:"UnsubscribeMultiApplied",value:i});function t(){return o.createSumType([new F("InitialSubscription",kt.getTypeScriptAlgebraicType()),new F("TransactionUpdate",jt.getTypeScriptAlgebraicType()),new F("TransactionUpdateLight",Mt.getTypeScriptAlgebraicType()),new F("IdentityToken",Rt.getTypeScriptAlgebraicType()),new F("OneOffQueryResponse",Nt.getTypeScriptAlgebraicType()),new F("SubscribeApplied",qt.getTypeScriptAlgebraicType()),new F("UnsubscribeApplied",$t.getTypeScriptAlgebraicType()),new F("SubscriptionError",Vt.getTypeScriptAlgebraicType()),new F("SubscribeMultiApplied",Ht.getTypeScriptAlgebraicType()),new F("UnsubscribeMultiApplied",Kt.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Jt||(Jt={}));var ue,gr,ct=(gr=class{constructor(){w(this,ue,new Map)}on(e,t){let r=a(this,ue).get(e);r||(r=new Set,a(this,ue).set(e,r)),r.add(t)}off(e,t){let r=a(this,ue).get(e);r&&r.delete(t)}emit(e,...t){let r=a(this,ue).get(e);if(r)for(let n of r)n(...t)}},ue=new WeakMap,gr),Vi={component:"",info:"",warn:"",error:"",debug:""},Hi={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Ki={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},oe=(e,t)=>{console.log(`%c${Vi[e]} ${e.toUpperCase()}%c ${t}`,Hi[e],Ki[e])},Ji=class{constructor(e){f(this,"rows");f(this,"tableTypeInfo");f(this,"emitter");f(this,"applyOperations",(e,t)=>{const r=[];if(this.tableTypeInfo.primaryKeyInfo!==void 0){const n=new Map,i=new Map;for(const s of e)if(s.type==="insert"){const[c,u]=n.get(s.rowId)||[s,0];n.set(s.rowId,[s,u+1])}else{const[c,u]=i.get(s.rowId)||[s,0];i.set(s.rowId,[s,u+1])}for(const[s,[c,u]]of n){const g=i.get(s);if(g){const[y,_]=g,A=u-_,j=this.update(t,s,c.row,A);j&&r.push(j),i.delete(s)}else{const y=this.insert(t,c,u);y&&r.push(y)}}for(const[s,c]of i.values()){const u=this.delete(t,s,c);u&&r.push(u)}}else for(const n of e)if(n.type==="insert"){const i=this.insert(t,n);i&&r.push(i)}else{const i=this.delete(t,n);i&&r.push(i)}return r});f(this,"update",(e,t,r,n=0)=>{const i=this.rows.get(t);if(!i){oe("error",`Updating a row that was not present in the cache. Table: ${this.tableTypeInfo.tableName}, RowId: ${t}`);return}const[s,c]=i,u=Math.max(1,c+n);if(c+n<=0){oe("error",`Negative reference count for in table ${this.tableTypeInfo.tableName} row ${t} (${c} + ${n})`);return}return this.rows.set(t,[r,u]),c===0?(oe("error",`Updating a row id in table ${this.tableTypeInfo.tableName} which was not present in the cache (rowId: ${t})`),{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,r)}}):{type:"update",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("update",e,s,r)}}});f(this,"insert",(e,t,r=1)=>{const[n,i]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,i+r]),i===0)return{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}});f(this,"delete",(e,t,r=1)=>{const[n,i]=this.rows.get(t.rowId)||[t.row,0];if(i===0){oe("warn","Deleting a row that was not present in the cache");return}if(i<=r)return this.rows.delete(t.rowId),{type:"delete",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("delete",e,t.row)}};this.rows.set(t.rowId,[t.row,i-r])});f(this,"onInsert",e=>{this.emitter.on("insert",e)});f(this,"onDelete",e=>{this.emitter.on("delete",e)});f(this,"onUpdate",e=>{this.emitter.on("update",e)});f(this,"removeOnInsert",e=>{this.emitter.off("insert",e)});f(this,"removeOnDelete",e=>{this.emitter.off("delete",e)});f(this,"removeOnUpdate",e=>{this.emitter.off("update",e)});this.tableTypeInfo=e,this.rows=new Map,this.emitter=new ct}count(){return this.rows.size}iter(){return Array.from(this.rows.values()).map(([e])=>e)}},Gi=class{constructor(){f(this,"tables");this.tables=new Map}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${e} does not exist`);return t}getOrCreateTable(e){let t;return this.tables.has(e.tableName)?t=this.tables.get(e.tableName):(t=new Ji(e),this.tables.set(e.tableName,t)),t}};function Wi(e,t){const r=Math.min(e.length,t.length);for(let n=0;n<r;n++){const i=e[n],s=t[n];if(i!==s)return typeof i=="number"&&typeof s=="number"?i-s:typeof i=="string"&&typeof s=="string"?i.localeCompare(s):typeof i=="string"?1:-1}return e.length-t.length}var Pr=class Gt{constructor(t,r,n,i=null,s=null){f(this,"major");f(this,"minor");f(this,"patch");f(this,"preRelease");f(this,"buildInfo");this.major=t,this.minor=r,this.patch=n,this.preRelease=i,this.buildInfo=s}toString(){let t=`${this.major}.${this.minor}.${this.patch}`;return this.preRelease&&(t+=`-${this.preRelease.join(".")}`),this.buildInfo&&(t+=`+${this.buildInfo}`),t}compare(t){return this.major!==t.major?this.major-t.major:this.minor!==t.minor?this.minor-t.minor:this.patch!==t.patch?this.patch-t.patch:this.preRelease&&t.preRelease?Wi(this.preRelease,t.preRelease):this.preRelease||t.preRelease?-1:0}clone(){return new Gt(this.major,this.minor,this.patch,this.preRelease?[...this.preRelease]:null,this.buildInfo)}static parseVersionString(t){const r=/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?(?:\+([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?$/,n=t.match(r);if(!n)throw new Error(`Invalid version string: ${t}`);const i=parseInt(n[1],10),s=parseInt(n[2],10),c=parseInt(n[3],10),u=n[4]?n[4].split(".").map(y=>isNaN(Number(y))?y:Number(y)):null,g=n[5]||null;return new Gt(i,s,c,u,g)}},jr=new Pr(1,2,0);function Zi(e){if(e===void 0)throw new Error(ar(e));if(Pr.parseVersionString(e).compare(jr)<0)throw new Error(ar(e))}function ar(e){return`Module code was generated with an incompatible version of the spacetimedb cli (${e}).  Update the cli version to at least ${jr.toString()} and regenerate the bindings. You can upgrade to the latest cli version by running: spacetime version upgrade`}async function Mr(e,t,r=128*1024){let n=0;const i=new ReadableStream({pull(N){if(n<e.length){const J=e.subarray(n,Math.min(n+r,e.length));N.enqueue(J),n+=r}else N.close()}}),s=new DecompressionStream(t),u=i.pipeThrough(s).getReader(),g=[];let y=0,_;for(;!(_=await u.read()).done;)g.push(_.value),y+=_.value.length;const A=new Uint8Array(y);let j=0;for(const N of g)A.set(N,j),j+=N.length;return A}var _e,re,Rr,Lr,Wt,we,Xi=(we=class{constructor(t){w(this,re);f(this,"onclose");f(this,"onopen");f(this,"onmessage");f(this,"onerror");w(this,_e);this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,t.onmessage=h(this,re,Rr).bind(this),t.onerror=h(this,re,Wt).bind(this),t.onclose=h(this,re,Wt).bind(this),t.onopen=h(this,re,Lr).bind(this),t.binaryType="arraybuffer",d(this,_e,t)}send(t){a(this,_e).send(t)}close(){a(this,_e).close()}static async createWebSocketFn({url:t,nameOrAddress:r,wsProtocol:n,authToken:i,compression:s,lightMode:c}){const u=new Headers;let g;g=WebSocket;let y;if(i){u.set("Authorization",`Bearer ${i}`);const j=new URL("v1/identity/websocket-token",t);j.protocol=t.protocol==="wss:"?"https:":"http:";const N=await fetch(j,{method:"POST",headers:u});if(N.ok){const{token:J}=await N.json();y=J}else return Promise.reject(new Error(`Failed to verify token: ${N.statusText}`))}const _=new URL(`v1/database/${r}/subscribe`,t);y&&_.searchParams.set("token",y),_.searchParams.set("compression",s==="gzip"?"Gzip":"None"),c&&_.searchParams.set("light","true");const A=new g(_.toString(),n);return new we(A)}},_e=new WeakMap,re=new WeakSet,Rr=async function(t){var i;const r=new Uint8Array(t.data);let n;if(r[0]===0)n=r.slice(1);else{if(r[0]===1)throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(r[0]===2)n=await Mr(r.slice(1),"gzip");else throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`")}(i=this.onmessage)==null||i.call(this,{data:n})},Lr=function(t){var r;(r=this.onopen)==null||r.call(this,t)},Wt=function(t){var r;(r=this.onerror)==null||r.call(this,t)},we),xe,Se,st,Be,pe,ke,Oe,Ie,yr,Yi=(yr=class{constructor(e,t){w(this,xe);w(this,Se);w(this,st);w(this,Be);w(this,pe,new ct);w(this,ke,"gzip");w(this,Oe,!1);w(this,Ie);this.remoteModule=e,this.dbConnectionConstructor=t,d(this,Ie,Xi.createWebSocketFn)}withUri(e){return d(this,xe,new URL(e)),this}withModuleName(e){return d(this,Se,e),this}withToken(e){return d(this,Be,e),this}withWSFn(e){return d(this,Ie,e),this}withCompression(e){return d(this,ke,e),this}withLightMode(e){return d(this,Oe,e),this}onConnect(e){return a(this,pe).on("connect",e),this}onConnectError(e){return a(this,pe).on("connectError",e),this}onDisconnect(e){return a(this,pe).on("disconnect",e),this}build(){var e;if(!a(this,xe))throw new Error("URI is required to connect to SpacetimeDB");if(!a(this,Se))throw new Error("Database name or address is required to connect to SpacetimeDB");return Zi((e=this.remoteModule.versionInfo)==null?void 0:e.cliVersion),this.dbConnectionConstructor(new qr({uri:a(this,xe),nameOrAddress:a(this,Se),identity:a(this,st),token:a(this,Be),emitter:a(this,pe),compression:a(this,ke),lightMode:a(this,Oe),createWSFn:a(this,Ie),remoteModule:this.remoteModule}))}},xe=new WeakMap,Se=new WeakMap,st=new WeakMap,Be=new WeakMap,pe=new WeakMap,ke=new WeakMap,Oe=new WeakMap,Ie=new WeakMap,yr),De,Pe,Tr,Nr=(Tr=class{constructor(e){w(this,De);w(this,Pe);this.db=e}onApplied(e){return d(this,De,e),this}onError(e){return d(this,Pe,e),this}subscribe(e){const t=Array.isArray(e)?e:[e];if(t.length===0)throw new Error("Subscriptions must have at least one query");return new en(this.db,t,a(this,De),a(this,Pe))}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},De=new WeakMap,Pe=new WeakMap,Tr),Qi=class{constructor(){f(this,"subscriptions",new Map)}},Ae,de,ne,se,ae,br,en=(br=class{constructor(e,t,r,n){w(this,Ae);w(this,de,!1);w(this,ne,!1);w(this,se,!1);w(this,ae,new ct);this.db=e,a(this,ae).on("applied",i=>{d(this,se,!0),r&&r(i)}),a(this,ae).on("error",(i,s)=>{d(this,se,!1),d(this,ne,!0),n&&n(i,s)}),d(this,Ae,this.db.registerSubscription(this,a(this,ae),t))}unsubscribe(){if(a(this,de))throw new Error("Unsubscribe has already been called");d(this,de,!0),this.db.unregisterSubscription(a(this,Ae)),a(this,ae).on("end",e=>{d(this,ne,!0),d(this,se,!1)})}unsubscribeThen(e){if(a(this,ne))throw new Error("Subscription has already ended");if(a(this,de))throw new Error("Unsubscribe has already been called");d(this,de,!0),this.db.unregisterSubscription(a(this,Ae)),a(this,ae).on("end",t=>{d(this,ne,!0),d(this,se,!1),e(t)})}isEnded(){return a(this,ne)}isActive(){return a(this,se)}},Ae=new WeakMap,de=new WeakMap,ne=new WeakMap,se=new WeakMap,ae=new WeakMap,br);function tn(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var je,M,ve,at,P,Me,Z,ot,U,$r,Ve,Vr,ce,Hr,Kr,rn,nn,sn,an,on,cn,ln,un,mr,qr=(mr=class{constructor({uri:e,nameOrAddress:t,identity:r,token:n,emitter:i,remoteModule:s,createWSFn:c,compression:u,lightMode:g}){w(this,U);f(this,"isActive",!1);f(this,"identity");f(this,"token");f(this,"db");f(this,"reducers");f(this,"setReducerFlags");f(this,"connectionId",mt.random());w(this,je,0);w(this,M);w(this,ve,new ct);w(this,at);w(this,P);w(this,Me,Promise.resolve());w(this,Z,new Qi);f(this,"clientCache");f(this,"ws");f(this,"wsPromise");w(this,ot,()=>{const e=a(this,je);return d(this,je,a(this,je)+1),e});f(this,"subscriptionBuilder",()=>new Nr(this));oe("info","Connecting to SpacetimeDB WS...");let y=new URL(e.toString());/^wss?:/.test(e.protocol)||(y.protocol=y.protocol==="https:"?"wss:":"ws:"),this.identity=r,this.token=n,d(this,P,s),d(this,M,i);let _=this.connectionId.toHexString();y.searchParams.set("connection_id",_),this.clientCache=new Gi,this.db=a(this,P).dbViewConstructor(this),this.setReducerFlags=a(this,P).setReducerFlagsConstructor(),this.reducers=a(this,P).reducersConstructor(this,this.setReducerFlags),this.wsPromise=c({url:y,nameOrAddress:t,wsProtocol:"v1.bsatn.spacetimedb",authToken:n,compression:u,lightMode:g}).then(A=>(this.ws=A,this.ws.onclose=()=>{a(this,M).emit("disconnect",this)},this.ws.onerror=j=>{a(this,M).emit("connectError",this,j)},this.ws.onopen=h(this,U,Vr).bind(this),this.ws.onmessage=h(this,U,Kr).bind(this),A)).catch(A=>{oe("error","Error connecting to SpacetimeDB WS"),a(this,M).emit("connectError",this,A)})}registerSubscription(e,t,r){const n=a(this,ot).call(this);return a(this,Z).subscriptions.set(n,{handle:e,emitter:t}),h(this,U,Ve).call(this,be.SubscribeMulti({queryStrings:r,queryId:{id:n},requestId:0})),n}unregisterSubscription(e){h(this,U,Ve).call(this,be.UnsubscribeMulti({queryId:{id:e},requestId:0}))}callReducer(e,t,r){const n=be.CallReducer({reducer:e,args:t,requestId:0,flags:tn(r)});h(this,U,Ve).call(this,n)}disconnect(){this.wsPromise.then(e=>{e&&e.close()})}onReducer(e,t){a(this,ve).on(e,t)}offReducer(e,t){a(this,ve).off(e,t)}},je=new WeakMap,M=new WeakMap,ve=new WeakMap,at=new WeakMap,P=new WeakMap,Me=new WeakMap,Z=new WeakMap,ot=new WeakMap,U=new WeakSet,$r=async function(e){const t=(i,s,c)=>{const u=c.rowsData,g=new me(u),y=[],_=a(this,P).tables[s].rowType,A=a(this,P).tables[s].primaryKeyInfo;for(;g.offset<u.length+u.byteOffset;){const j=g.offset,N=_.deserialize(g);let J;if(A!==void 0)J=A.colType.intoMapKey(N[A.colName]);else{const ee=u.subarray(j-u.byteOffset,g.offset-u.byteOffset);J=Er(ee)}y.push({type:i,rowId:J,row:N})}return y},r=async i=>{const s=i.tableName;let c=[];for(const u of i.updates){let g;if(u.tag==="Gzip"){const y=await Mr(u.value,"gzip");g=We.deserialize(new me(y))}else{if(u.tag==="Brotli")throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");g=u.value}c=c.concat(t("insert",s,g.inserts)),c=c.concat(t("delete",s,g.deletes))}return{tableName:s,operations:c}},n=async i=>{const s=[];for(const c of i.tables)s.push(await r(c));return s};switch(e.tag){case"InitialSubscription":{const i=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await n(i)}}case"TransactionUpdateLight":{const i=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await n(i)}}case"TransactionUpdate":{const i=e.value,s=i.callerIdentity,c=mt.nullIfZero(i.callerConnectionId),u=i.reducerCall.reducerName,g=i.reducerCall.args,y=i.energyQuantaUsed;let _,A="";switch(i.status.tag){case"Committed":_=await n(i.status.value);break;case"Failed":_=[],A=i.status.value;break;case"OutOfEnergy":_=[];break}if(u==="<none>"){console.error(`Received an error from the database: ${A}`);return}let j;return u!==""&&(j={reducerName:u,args:g}),{tag:"TransactionUpdate",tableUpdates:_,identity:s,connectionId:c,reducerInfo:j,status:i.status,energyConsumed:y.quanta,message:A,timestamp:i.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const i=await n(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:i}}case"UnsubscribeMultiApplied":{const i=await n(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:i}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error}}},Ve=function(e){this.wsPromise.then(t=>{if(t){const r=new Y(1024);be.serialize(r,e);const n=r.getBuffer();t.send(n)}})},Vr=function(){this.isActive=!0},ce=function(e,t){let r=[];for(let n of e){const i=n.tableName,s=a(this,P).tables[i],u=this.clientCache.getOrCreateTable(s).applyOperations(n.operations,t);for(const g of u)r.push(g)}return r},Hr=async function(e){var n,i;const t=$i(Jt,e),r=await h(this,U,$r).call(this,t);if(r)switch(r.tag){case"InitialSubscription":{let s={tag:"SubscribeApplied"};const c=a(this,P).eventContextConstructor(this,s),{event:u,...g}=c,y=h(this,U,ce).call(this,r.tableUpdates,c);a(this,M)&&((n=a(this,at))==null||n.call(this,g));for(const _ of y)_.cb();break}case"TransactionUpdateLight":{let s={tag:"UnknownTransaction"};const c=a(this,P).eventContextConstructor(this,s),u=h(this,U,ce).call(this,r.tableUpdates,c);for(const g of u)g.cb();break}case"TransactionUpdate":{let s=r.reducerInfo,c=!1,u,g;if(!s)c=!0;else{g=a(this,P).reducers[s.reducerName];try{const ee=new me(s.args);u=g.argsType.deserialize(ee)}catch{console.debug("Failed to deserialize reducer arguments"),c=!0}}if(c){const ee={tag:"UnknownTransaction"},lt=a(this,P).eventContextConstructor(this,ee),Zr=h(this,U,ce).call(this,r.tableUpdates,lt);for(const Xr of Zr)Xr.cb();return}s=s,g=g;const y={callerIdentity:r.identity,status:r.status,callerConnectionId:r.connectionId,timestamp:r.timestamp,energyConsumed:r.energyConsumed,reducer:{name:s.reducerName,args:u}},_={tag:"Reducer",value:y},A=a(this,P).eventContextConstructor(this,_),j={...A,event:y},N=h(this,U,ce).call(this,r.tableUpdates,A),J=[];g.argsType.product.elements.forEach((ee,lt)=>{J.push(u[ee.name])}),a(this,ve).emit(s.reducerName,j,...J);for(const ee of N)ee.cb();break}case"IdentityToken":{this.identity=r.identity,!this.token&&r.token&&(this.token=r.token),this.connectionId=r.connectionId,a(this,M).emit("connect",this,this.identity,this.token);break}case"SubscribeApplied":{const s=a(this,Z).subscriptions.get(r.queryId);if(s===void 0){oe("error",`Received SubscribeApplied for unknown queryId ${r.queryId}.`);break}const c={tag:"SubscribeApplied"},u=a(this,P).eventContextConstructor(this,c),{event:g,...y}=u,_=h(this,U,ce).call(this,r.tableUpdates,u);s==null||s.emitter.emit("applied",y);for(const A of _)A.cb();break}case"UnsubscribeApplied":{const s=a(this,Z).subscriptions.get(r.queryId);if(s===void 0){oe("error",`Received UnsubscribeApplied for unknown queryId ${r.queryId}.`);break}const c={tag:"UnsubscribeApplied"},u=a(this,P).eventContextConstructor(this,c),{event:g,...y}=u,_=h(this,U,ce).call(this,r.tableUpdates,u);s==null||s.emitter.emit("end",y),a(this,Z).subscriptions.delete(r.queryId);for(const A of _)A.cb();break}case"SubscriptionError":{const s=Error(r.error),c={tag:"Error",value:s},g={...a(this,P).eventContextConstructor(this,c),event:s};r.queryId!==void 0?((i=a(this,Z).subscriptions.get(r.queryId))==null||i.emitter.emit("error",g,s),a(this,Z).subscriptions.delete(r.queryId)):(console.error("Received an error message without a queryId: ",s),a(this,Z).subscriptions.forEach(({emitter:y})=>{y.emit("error",g,s)}))}}},Kr=function(e){d(this,Me,a(this,Me).then(()=>h(this,U,Hr).call(this,e.data)))},rn=function(e,t){a(this,M).on(e,t)},nn=function(e,t){a(this,M).off(e,t)},sn=function(e){a(this,M).on("connect",e)},an=function(e){a(this,M).on("disconnect",e)},on=function(e){a(this,M).on("connectError",e)},cn=function(e){a(this,M).off("connect",e)},ln=function(e){a(this,M).off("disconnect",e)},un=function(e){a(this,M).off("connectError",e)},mr),Ye;(e=>{function t(){return o.createProductType([new l("voteId",o.createU64Type()),new l("optionId",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ye||(Ye={}));var Qe;(e=>{function t(){return o.createProductType([new l("title",o.createStringType()),new l("options",o.createArrayType(o.createStringType())),new l("isPublic",o.createOptionType(o.createBoolType()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Qe||(Qe={}));var et;(e=>{function t(){return o.createProductType([new l("voteId",o.createU64Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(et||(et={}));var tt;(e=>{function t(){return o.createProductType([new l("voteId",o.createU64Type()),new l("optionIds",o.createArrayType(o.createU32Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(tt||(tt={}));var rt;(e=>{function t(){return o.createProductType([new l("voteId",o.createU64Type()),new l("optionId",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(rt||(rt={}));class pn{constructor(t){this.onInsert=r=>this.tableCache.onInsert(r),this.removeOnInsert=r=>this.tableCache.removeOnInsert(r),this.onDelete=r=>this.tableCache.onDelete(r),this.removeOnDelete=r=>this.tableCache.removeOnDelete(r),this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class dn{constructor(t){this.id={find:r=>{for(let n of this.tableCache.iter())if(Re(n.id,r))return n}},this.onInsert=r=>this.tableCache.onInsert(r),this.removeOnInsert=r=>this.tableCache.removeOnInsert(r),this.onDelete=r=>this.tableCache.onDelete(r),this.removeOnDelete=r=>this.tableCache.removeOnDelete(r),this.onUpdate=r=>this.tableCache.onUpdate(r),this.removeOnUpdate=r=>this.tableCache.removeOnUpdate(r),this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class hn{constructor(t){this.id={find:r=>{for(let n of this.tableCache.iter())if(Re(n.id,r))return n}},this.onInsert=r=>this.tableCache.onInsert(r),this.removeOnInsert=r=>this.tableCache.removeOnInsert(r),this.onDelete=r=>this.tableCache.onDelete(r),this.removeOnDelete=r=>this.tableCache.removeOnDelete(r),this.onUpdate=r=>this.tableCache.onUpdate(r),this.removeOnUpdate=r=>this.tableCache.removeOnUpdate(r),this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}var Zt;(e=>{function t(){return o.createProductType([new l("voteId",o.createU64Type()),new l("optionId",o.createU32Type()),new l("voter",o.createIdentityType()),new l("ts",o.createTimestampType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Zt||(Zt={}));var it;(e=>{function t(){return o.createProductType([new l("id",o.createU64Type()),new l("creator",o.createIdentityType()),new l("title",o.createStringType()),new l("public",o.createBoolType()),new l("createdAt",o.createTimestampType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(it||(it={}));var nt;(e=>{function t(){return o.createProductType([new l("id",o.createU32Type()),new l("voteId",o.createU64Type()),new l("label",o.createStringType()),new l("approvalsCount",o.createU32Type()),new l("orderIndex",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(nt||(nt={}));const He={tables:{approval:{tableName:"approval",rowType:Zt.getTypeScriptAlgebraicType()},vote:{tableName:"vote",rowType:it.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:it.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},vote_option:{tableName:"vote_option",rowType:nt.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:nt.getTypeScriptAlgebraicType().product.elements[0].algebraicType}}},reducers:{approve:{reducerName:"approve",argsType:Ye.getTypeScriptAlgebraicType()},create_vote:{reducerName:"create_vote",argsType:Qe.getTypeScriptAlgebraicType()},delete_vote:{reducerName:"delete_vote",argsType:et.getTypeScriptAlgebraicType()},set_approvals:{reducerName:"set_approvals",argsType:tt.getTypeScriptAlgebraicType()},unapprove:{reducerName:"unapprove",argsType:rt.getTypeScriptAlgebraicType()}},versionInfo:{cliVersion:"1.3.2"},eventContextConstructor:(e,t)=>({...e,event:t}),dbViewConstructor:e=>new yn(e),reducersConstructor:(e,t)=>new fn(e,t),setReducerFlagsConstructor:()=>new gn};class fn{constructor(t,r){this.connection=t,this.setCallReducerFlags=r}approve(t,r){const n={voteId:t,optionId:r};let i=new Y(1024);Ye.getTypeScriptAlgebraicType().serialize(i,n);let s=i.getBuffer();this.connection.callReducer("approve",s,this.setCallReducerFlags.approveFlags)}onApprove(t){this.connection.onReducer("approve",t)}removeOnApprove(t){this.connection.offReducer("approve",t)}createVote(t,r,n){const i={title:t,options:r,isPublic:n};let s=new Y(1024);Qe.getTypeScriptAlgebraicType().serialize(s,i);let c=s.getBuffer();this.connection.callReducer("create_vote",c,this.setCallReducerFlags.createVoteFlags)}onCreateVote(t){this.connection.onReducer("create_vote",t)}removeOnCreateVote(t){this.connection.offReducer("create_vote",t)}deleteVote(t){const r={voteId:t};let n=new Y(1024);et.getTypeScriptAlgebraicType().serialize(n,r);let i=n.getBuffer();this.connection.callReducer("delete_vote",i,this.setCallReducerFlags.deleteVoteFlags)}onDeleteVote(t){this.connection.onReducer("delete_vote",t)}removeOnDeleteVote(t){this.connection.offReducer("delete_vote",t)}setApprovals(t,r){const n={voteId:t,optionIds:r};let i=new Y(1024);tt.getTypeScriptAlgebraicType().serialize(i,n);let s=i.getBuffer();this.connection.callReducer("set_approvals",s,this.setCallReducerFlags.setApprovalsFlags)}onSetApprovals(t){this.connection.onReducer("set_approvals",t)}removeOnSetApprovals(t){this.connection.offReducer("set_approvals",t)}unapprove(t,r){const n={voteId:t,optionId:r};let i=new Y(1024);rt.getTypeScriptAlgebraicType().serialize(i,n);let s=i.getBuffer();this.connection.callReducer("unapprove",s,this.setCallReducerFlags.unapproveFlags)}onUnapprove(t){this.connection.onReducer("unapprove",t)}removeOnUnapprove(t){this.connection.offReducer("unapprove",t)}}class gn{constructor(){this.approveFlags="FullUpdate",this.createVoteFlags="FullUpdate",this.deleteVoteFlags="FullUpdate",this.setApprovalsFlags="FullUpdate",this.unapproveFlags="FullUpdate"}approve(t){this.approveFlags=t}createVote(t){this.createVoteFlags=t}deleteVote(t){this.deleteVoteFlags=t}setApprovals(t){this.setApprovalsFlags=t}unapprove(t){this.unapproveFlags=t}}class yn{constructor(t){this.connection=t}get approval(){return new pn(this.connection.clientCache.getOrCreateTable(He.tables.approval))}get vote(){return new dn(this.connection.clientCache.getOrCreateTable(He.tables.vote))}get voteOption(){return new hn(this.connection.clientCache.getOrCreateTable(He.tables.vote_option))}}class Tn extends Nr{}const Yt=class Yt extends qr{constructor(){super(...arguments),this.subscriptionBuilder=()=>new Tn(this)}};Yt.builder=()=>new Yi(He,t=>t);let Xt=Yt;const or=document.getElementById("status"),fe=document.getElementById("my-vote-list"),ge=document.getElementById("public-vote-list"),ze=document.getElementById("detail"),Ke=document.getElementById("module-name"),Je=document.getElementById("server-uri"),cr=document.getElementById("create-form"),bn=document.getElementById("title"),lr=document.getElementById("options"),mn=document.getElementById("public"),ur=document.getElementById("identity-text"),ft=document.getElementById("reset-identity");var _r;const Jr=((_r=Ke==null?void 0:Ke.textContent)==null?void 0:_r.trim())||"zvote-proto1";var wr;const Gr=((wr=Je==null?void 0:Je.textContent)==null?void 0:wr.trim())||"ws://localhost:3000";let C=null,G=null,Ce=null;function Ne(e){or&&(or.textContent=e)}function ye(){if(!C)return;fe&&(fe.innerHTML=""),ge&&(ge.innerHTML="");const e=[];for(const n of C.db.vote.iter())e.push(n);e.sort((n,i)=>vn(n,i));let t=0,r=0;for(const n of e){const i=Ce&&Re(n.creator,Ce),s=!!n.public;i&&fe?(pr(fe,n,!0),t++):s&&ge&&(pr(ge,n,!1),r++)}fe&&fe.classList.toggle("scrollable",t>10),ge&&ge.classList.toggle("scrollable",r>10)}function ie(){if(!C)return;if(G==null){ze.textContent="Select a vote to view details.";return}const e=C.db.vote.id.find(G);if(!e){ze.textContent=`Vote #${G.toString()} not found.`;return}const t=[];for(const c of C.db.voteOption.iter())c.voteId===G&&t.push(c);t.sort((c,u)=>u.approvalsCount!==c.approvalsCount?u.approvalsCount-c.approvalsCount:c.orderIndex-u.orderIndex);const r=Sn(G);ze.innerHTML="";const n=document.createElement("div");n.innerHTML=`<div><strong>Title:</strong> ${Wr(e.title)}</div><div><strong>ID:</strong> ${e.id.toString()}</div>`,ze.appendChild(n);const i=document.createElement("ul");i.className="option-list";const s=r;for(const c of t){const u=document.createElement("li");u.className="option-row";const g=document.createElement("div");g.className="option-left";const y=document.createElement("input");y.type="checkbox",y.checked=s.has(c.id),y.title="Toggle your approval for this option",y.addEventListener("change",()=>{y.checked?C.reducers.approve(G,c.id):C.reducers.unapprove(G,c.id)});const _=document.createElement("span");_.textContent=c.label,g.append(y,_);const A=document.createElement("div");A.innerHTML=`<span class="badge">${c.approvalsCount}</span>`,u.append(g,A),i.appendChild(u)}ze.appendChild(i)}function Wr(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}function _n(){cr&&(cr.addEventListener("submit",e=>{if(e.preventDefault(),!C)return;const t=bn.value.trim(),r=!!mn.checked,n=lr.value.split(/\r?\n/).map(i=>i.trim()).filter(i=>i.length>0);if(!t){alert("Title is required");return}if(n.length===0){alert("Please enter at least one option (one per line).");return}C.reducers.createVote(t,n,r),lr.value=""}),ft==null||ft.addEventListener("click",()=>{confirm("Switch to a fresh identity? This will reconnect and give you a new identity.")&&(localStorage.removeItem("auth_token"),location.reload())}))}function wn(){Ne("Connecting");const e=localStorage.getItem("auth_token")||"",t=(i,s,c)=>{C=i,Ce=s,localStorage.setItem("auth_token",c),Ne("Connected"),ur&&(ur.textContent=Fn(s)),C.subscriptionBuilder().onApplied(()=>{ye(),ie()}).subscribe(["SELECT * FROM vote","SELECT * FROM vote_option","SELECT * FROM approval"]),C.db.vote.onInsert(()=>ye()),C.db.vote.onUpdate(()=>ye()),C.db.vote.onDelete(()=>{G!=null&&!C.db.vote.id.find(G)&&(G=null),ye(),ie()}),C.db.voteOption.onInsert(()=>ie()),C.db.voteOption.onUpdate(()=>ie()),C.db.voteOption.onDelete(()=>ie()),C.db.approval.onInsert(()=>{ye(),ie()}),C.db.approval.onDelete(()=>{ye(),ie()})},r=()=>{Ne("Disconnected")},n=(i,s)=>{console.error("Error connecting to SpacetimeDB:",s),Ne("Error connecting")};Xt.builder().withUri(Gr).withModuleName(Jr).withToken(e).onConnect(t).onDisconnect(r).onConnectError(n).build()}function xn(){Ke.textContent=Jr,Je.textContent=Gr,_n(),wn()}xn();function pr(e,t,r){const n=document.createElement("li"),i=document.createElement("div"),s=document.createElement("div");s.className="item-actions";const c=In(t.id),u=t.maxParticipants??t.participantsLimit??null,g=u?`(${c}/${u})`:`${c}`;i.innerHTML=`<strong>${Wr(t.title)}</strong> <span class="badge">${g}</span> <span class="badge">#${t.id.toString()}</span>${r?' <span class="badge">me</span>':""}`;const y=document.createElement("button");y.textContent="View",y.className="secondary",y.addEventListener("click",()=>{G=t.id,ie()});const _=document.createElement("button");_.textContent="Delete",r||(_.disabled=!0,_.title="Only the vote creator can delete this vote"),_.addEventListener("click",()=>{_.disabled||confirm(`Delete vote "${t.title}"?`)&&C.reducers.deleteVote(t.id)}),s.append(y,_),n.append(i,s),e.appendChild(n)}function Sn(e){const t=new Set;if(!C||!Ce)return t;for(const r of C.db.approval.iter())r.voteId===e&&Re(r.voter,Ce)&&t.add(r.optionId);return t}function In(e){const t=new Set;if(!C)return 0;for(const r of C.db.approval.iter())r.voteId===e&&t.add(An(r.voter));return t.size}function An(e){try{return e?typeof e.toBase58=="function"?e.toBase58():typeof e.toHex=="function"?e.toHex():typeof e=="string"?e:typeof e.toString=="function"?e.toString():JSON.stringify(e):"null"}catch{return String(e)}}function vn(e,t){const r=dr(e);return dr(t)-r}function dr(e){const t=e.createdAt??e.created_at??0;return typeof t=="bigint"?Number(t):typeof t=="number"?t:t&&typeof t.toNumber=="function"?t.toNumber():0}function Fn(e){try{if(!e)return"";let t;typeof e=="string"&&(t=e),!t&&typeof e.toString=="function"&&(t=e.toString()),t==="[object Object]"&&(t=void 0),!t&&typeof e.toBase58=="function"&&(t=e.toBase58()),!t&&typeof e.toHex=="function"&&(t=e.toHex()),t||(t=JSON.stringify(e));const r=String(t);return r.length>20?`${r.slice(0,10)}${r.slice(-6)}`:r}catch{return""}}
